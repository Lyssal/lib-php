<?php
/**
 * This file is part of the Lyssal PHP library.
 *
 * @copyright Rémi Leclerc
 * @author Rémi Leclerc
 */
namespace Lyssal\Text;

/**
 * Class to manipulate HTML.
 */
class Html extends AbstractText
{
    /**
     * Transforms isolated URL into HTTM links.
     *
     * @return \Lyssal\Text\Html Html
     */
    public function makeClickableLinks()
    {
        $this->text = trim(preg_replace(
            "#(<a( [^>]+?>|>))<a [^>]+?>([^>]+?)</a></a>#i",
            "$1$3</a>",
            preg_replace_callback(
                '#([\s>])(([a-zA-Z0-9\-]+\.){1}[\w\\x80-\\xff\#$%&~/.\-;:=,?@\[\]+]*)#is',
                function ($matches) {
                    return $this->makeClickableUrlCallback($matches, 'http://');
                },
                preg_replace_callback(
                    '#([\s>])([\w]+?://[\w\\x80-\\xff\#$%&~/.\-;:=,?@\[\]+]*)#is',
                    function ($matches) {
                        return $this->makeClickableUrlCallback($matches);
                    },
                    ' '.$this->text
                )
            )
        ));

        return $this;
    }

    /**
     * Transforms URL into HTML links (called by preg_replace_callback).
     *
     * @param array  $matches Matches
     * @param string $prefix  Prefix to add to links
     * @return string HTML
     */
    protected function makeClickableUrlCallback(array $matches, $prefix = '')
    {
        $text = '';
        $url = $matches[2];

        if ('' == $url) {
            return $matches[0];
        }

        if (in_array(substr($url, -1), array('.', ',', ';', ':'), false)) {
            $text = substr($url, -1);
            $url = substr($url, 0, -1);
        }

        return $matches[1].'<a href="'.$prefix.$url.'">'.$url.'</a>'.$text;
    }

    /**
     * Transforms isolated emails into mailto links.
     *
     * @return \Lyssal\Text\Html Html
     */
    public function makeClickableEmails()
    {
        $this->text = trim(preg_replace(
            "#(<a( [^>]+?>|>))<a [^>]+?>([^>]+?)</a></a>#i",
            "$1$3</a>",
            preg_replace_callback(
                '#([\s>])([.0-9a-z_+-]+)@(([0-9a-z-]+\.)+[0-9a-z]{2,})#i',
                function ($matches) {
                    return $this->makeClickableEmailCallback($matches);
                },
                ' '.$this->text
            )
        ));

        return $this;
    }

    /**
     * Transforms emails into mailto links (called by preg_replace_callback).
     *
     * @param array $matches Matches
     * @return string HTML
     */
    protected function makeClickableEmailCallback(array $matches)
    {
        $email = $matches[2].'@'.$matches[3];
        return $matches[1].'<a href="mailto:'.$email.'">'.$email.'</a>';
    }
}

